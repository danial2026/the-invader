package renderer

import (
	"image/color"
	"image"
)

var fontData = map[rune][]byte{
	'A': {0x70, 0x88, 0x88, 0xF8, 0x88, 0x88, 0x88},
	'B': {0xF0, 0x88, 0x88, 0xF0, 0x88, 0x88, 0xF0},
	'C': {0x78, 0x80, 0x80, 0x80, 0x80, 0x80, 0x78},
	'D': {0xF0, 0x88, 0x88, 0x88, 0x88, 0x88, 0xF0},
	'E': {0xF8, 0x80, 0x80, 0xF0, 0x80, 0x80, 0xF8},
	'F': {0xF8, 0x80, 0x80, 0xF0, 0x80, 0x80, 0x80},
	'G': {0x78, 0x80, 0x80, 0x98, 0x88, 0x88, 0x78},
	'H': {0x88, 0x88, 0x88, 0xF8, 0x88, 0x88, 0x88},
	'I': {0x70, 0x20, 0x20, 0x20, 0x20, 0x20, 0x70},
	'J': {0x08, 0x08, 0x08, 0x08, 0x08, 0x88, 0x70},
	'K': {0x88, 0x90, 0xA0, 0xC0, 0xA0, 0x90, 0x88},
	'L': {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xF8},
	'M': {0x88, 0xD8, 0xA8, 0x88, 0x88, 0x88, 0x88},
	'N': {0x88, 0xC8, 0xA8, 0x98, 0x88, 0x88, 0x88},
	'O': {0x70, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70},
	'P': {0xF0, 0x88, 0x88, 0xF0, 0x80, 0x80, 0x80},
	'Q': {0x70, 0x88, 0x88, 0x88, 0xA8, 0x90, 0x68},
	'R': {0xF0, 0x88, 0x88, 0xF0, 0xA0, 0x90, 0x88},
	'S': {0x70, 0x88, 0x80, 0x70, 0x08, 0x88, 0x70},
	'T': {0xF8, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20},
	'U': {0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70},
	'V': {0x88, 0x88, 0x88, 0x50, 0x50, 0x20, 0x20},
	'W': {0x88, 0x88, 0x88, 0xA8, 0xA8, 0xD8, 0x88},
	'X': {0x88, 0x88, 0x50, 0x20, 0x50, 0x88, 0x88},
	'Y': {0x88, 0x88, 0x50, 0x20, 0x20, 0x20, 0x20},
	'Z': {0xF8, 0x08, 0x10, 0x20, 0x40, 0x80, 0xF8},
	'0': {0x70, 0x88, 0x98, 0xA8, 0xC8, 0x88, 0x70},
	'1': {0x20, 0x60, 0x20, 0x20, 0x20, 0x20, 0x70},
	'2': {0x70, 0x88, 0x08, 0x30, 0x40, 0x80, 0xF8},
	'3': {0xF8, 0x08, 0x10, 0x08, 0x08, 0x88, 0x70},
	'4': {0x10, 0x30, 0x50, 0x90, 0xF8, 0x10, 0x10},
	'5': {0xF8, 0x80, 0xF0, 0x08, 0x08, 0x88, 0x70},
	'6': {0x30, 0x40, 0x80, 0xF0, 0x88, 0x88, 0x70},
	'7': {0xF8, 0x08, 0x10, 0x20, 0x20, 0x20, 0x20},
	'8': {0x70, 0x88, 0x88, 0x70, 0x88, 0x88, 0x70},
	'9': {0x70, 0x88, 0x88, 0x78, 0x08, 0x48, 0x30},
	'.': {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60},
	',': {0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x40},
	'!': {0x20, 0x20, 0x20, 0x20, 0x00, 0x00, 0x20},
	'?': {0x70, 0x88, 0x10, 0x20, 0x00, 0x00, 0x20},
	'-': {0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00},
	':': {0x00, 0x60, 0x60, 0x00, 0x60, 0x60, 0x00},
	'[': {0x38, 0x20, 0x20, 0x20, 0x20, 0x20, 0x38},
	']': {0x38, 0x08, 0x08, 0x08, 0x08, 0x08, 0x38},
	'\'':{0x20, 0x20, 0x40, 0x00, 0x00, 0x00, 0x00},
}

func DrawText(dst *image.RGBA, startX, startY int, text string, c color.Color) {
	DrawTextScaled(dst, startX, startY, text, c, 1)
}

func DrawTextScaled(dst *image.RGBA, startX, startY int, text string, c color.Color, scale float64) {
	if scale < 0.1 {
		scale = 0.1
	}
	
	x := float64(startX)
	y := float64(startY)

	r, g, b, a := c.RGBA()
	col := color.RGBA{uint8(r), uint8(g), uint8(b), uint8(a)}

	for _, char := range text {
		if char >= 'a' && char <= 'z' {
			char -= 32
		}

		if char == ' ' {
			x += 4.0 * scale
			continue
		}

		data, ok := fontData[char]
		if !ok {
			w := int(5.0 * scale)
			h := int(7.0 * scale)
			for dy := 0; dy < h; dy++ {
				for dx := 0; dx < w; dx++ {
					dst.Set(int(x)+dx, int(y)+dy, col)
				}
			}
			x += (6.0 * scale)
			continue
		}

		for row := 0; row < 7; row++ {
			bits := data[row]
			yStart := int(y + float64(row)*scale)
			yEnd := int(y + float64(row+1)*scale)
			
			for bit := 0; bit < 5; bit++ {
				if (bits >> (7 - bit)) & 1 == 1 {
					xStart := int(x + float64(bit)*scale)
					xEnd := int(x + float64(bit+1)*scale)
					
					for py := yStart; py < yEnd; py++ {
						for px := xStart; px < xEnd; px++ {
							dst.Set(px, py, col)
						}
					}
				}
			}
		}
		x += (6.0 * scale)
	}
}
